# Multi-stage build for PR Auto-Reviewer with Claude Code
FROM node:20-slim AS base

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        ca-certificates \
        python3 \
        python3-pip \
        python3-venv \
        git && \
    rm -rf /var/lib/apt/lists/*

# 安装 Claude Code CLI
RUN npm install -g @anthropic/claude-code

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip3 install --no-cache-dir --break-system-packages -r requirements.txt

# 复制应用代码
COPY pr_reviewer.py .
COPY config.yaml .

# 创建非 root 用户
RUN useradd -m -u 1000 -s /bin/bash appuser && \
    mkdir -p /var/log/github-monitor /home/appuser/.config/claude-code && \
    chown -R appuser:appuser /app /var/log/github-monitor /home/appuser

# 切换到非 root 用户
USER appuser

# 暴露 webhook 端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV FLASK_APP=pr_reviewer.py
ENV CLAUDE_CODE_PATH=/usr/local/bin/claude-code

# 启动命令
CMD ["python3", "pr_reviewer.py"]
